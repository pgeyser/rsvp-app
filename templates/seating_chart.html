{% extends "base.html" %}

{% block title %}Seating Chart - Masquerade Awards{% endblock %}

{% block content %}
<div class="container">
    <h1>Select Your Table for the Masquerade</h1>
    
    <div class="deadline-notice">
        <p><strong>Note:</strong> Seat selection deadline is {{ deadline }}. 
        {% if deadline_passed %}
            <span class="error">The deadline has passed. You cannot change your seat.</span>
        {% else %}
            <span class="info">You can still change your seat until this date.</span>
        {% endif %}
        </p>
    </div>

    <div class="seating-legend">
        <div class="legend-item">
            <div class="seat available"></div>
            <span>Available</span>
        </div>
        <div class="legend-item">
            <div class="seat occupied"></div>
            <span>Occupied</span>
        </div>
        <div class="legend-item">
            <div class="seat selected"></div>
            <span>Your Seat</span>
        </div>
    </div>

    <div class="seating-chart">
        {% for table_name, table_seats in seats.items() %}
            <div class="table" data-table="{{ table_name }}">                
                <h3>{{ table_name.replace('_', ' ').title() }}
                </h3>
                <div class="seats-grid">
                    {% for i in range(10) %}
                        <div class="seat {% if table_seats[i] %}occupied{% else %}available{% endif %}" 
                             data-table="{{ table_name }}" 
                             data-seat="{{ i }}"
                            {% if table_seats[i] %}
                                title="{{ table_seats[i].full_name }} {{ table_seats[i].surname }}"
                            {% else %}
                                title="Available"
                            {% endif %}
                             {% if not deadline_passed and not table_seats[i] %}onclick="selectSeat('{{ table_name }}', {{ i }})"{% endif %}>
                            <span class="seat-number">{{ i + 1 }}</span>
                            <!-- {% if table_seats[i] %}
                                <span class="occupant-name">{{ table_seats[i].full_name }} {{ table_seats[i].surname }}</span>
                            {% endif %} -->
                        </div>
                    {% endfor %}
                </div>  <br/>
                <span class="table-occupants-icon" 
                        title="Show all occupants"
                        onclick="toggleTableOccupants('{{ table_name }}')"
                        style="cursor:pointer;">
                        show quests ?
                    </span>              
                <div class="table-occupants-list" id="occupants-list-{{ table_name }}" style="display:none; margin-top:1em; color:white"></div>        
            </div>
        {% endfor %}          
    </div>
    <div style="width: 100%; text-align: center;" class="form-actions">
        <a href="{{ url_for('success', email=email) }}" class="btn btn-secondary">Continue to Confirmation</a>
    </div>
</div>

<script>
const userEmail = '{{ email }}';
let selectedSeat = null;

// Notification function
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
        color: white;
        padding: 1rem 2rem;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    // Animate out and remove
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

function selectSeat(table, seatIndex) {
    {% if deadline_passed %}
        alert('Seat selection deadline has passed.');
        return;
    {% endif %}
    
    fetch('/api/select-seat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            email: userEmail,
            table: table,
            seat: seatIndex
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove user from any previous seat
            document.querySelectorAll('.seat').forEach(seat => {
                if (seat.classList.contains('selected')) {
                    seat.classList.remove('selected');
                    seat.classList.add('available');
                    seat.innerHTML = '<span class="seat-number">' + (parseInt(seat.dataset.seat) + 1) + '</span>';
                }
            });
            
            // Update the selected seat
            const seatElement = document.querySelector(`[data-table="${table}"][data-seat="${seatIndex}"]`);
            seatElement.classList.remove('available');
            seatElement.classList.add('selected');
            seatElement.innerHTML = '<span class="seat-number">' + (seatIndex + 1) + '</span><span class="occupant-name">You</span>';
            
            // Show success message
            showNotification(data.message, 'success');
            
            // Update seat info
            showSeatInfo(table, seatIndex);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error selecting seat. Please try again.');
    });
}

function titleCase(str) {
    if (!str) return 'Unknown Table';
    return str.replace('_', ' ').replace(/\w\S*/g, (txt) => 
        txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
    );
}

function showSeatInfo(table, seatIndex) {
    fetch(`/api/seat-info?table=${table}&seat=${seatIndex}`)
    .then(response => response.json())
    .then(data => {
        const infoDiv = document.getElementById('seat-info');
        if (data.occupied) {
            infoDiv.innerHTML = `<p><strong>Seat ${seatIndex + 1} at ${titleCase(table)}:</strong> Occupied by ${data.occupant}</p>`;
        } else {
            infoDiv.innerHTML = `<p><strong>Seat ${seatIndex + 1} at ${titleCase(table)}:</strong> Available</p>`;
        }
    });
}

function toggleTableOccupants(tableName) {
    const tableDiv = document.querySelector(`.table[data-table="${tableName}"]`);
    const seats = tableDiv.querySelectorAll('.seat.occupied');
    const occupantsListDiv = document.getElementById(`occupants-list-${tableName}`);

    if (occupantsListDiv.style.display === 'none' || occupantsListDiv.style.display === '') {
        // Build occupants list
        const occupants = [];
        seats.forEach(seat => {
            const occupant = seat.getAttribute('title');
            if (occupant && occupant !== 'Available') {
                occupants.push(occupant);
            }
        });

        let html = '<strong></strong><p style="margin:0.5em 0 0 0; padding-left:1em;">';
        if (occupants.length > 0) {
            occupants.forEach(name => {
                html += `<p>${name}</p>`;
            });
        } else {
            html += '<p><em>No one assigned yet.</em></p>';
        }
        html += '</p>';

        occupantsListDiv.innerHTML = html;
        occupantsListDiv.style.display = 'block';
    } else {
        occupantsListDiv.style.display = 'none';
    }
}

// Add hover effect for seat info
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.seat').forEach(seat => {
        seat.addEventListener('mouseenter', function() {
            const table = this.dataset.table;
            const seatIndex = this.dataset.seat;
            showSeatInfo(table, parseInt(seatIndex));
        });
    });
});
</script>
{% endblock %}